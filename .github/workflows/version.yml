name: Generate Version JSON

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Generate version JSON
        id: generate_version
        run: |
          VALID_COUNT=0
          for COMMIT in $(git rev-list --reverse --since="2025-07-18" HEAD); do
              AUTHOR=$(git show -s --format='%ae' $COMMIT)
              PARENTS=$(git rev-list --parents -n 1 $COMMIT | wc -w)

              if [[ "$AUTHOR" != "github-actions@github.com" && "$PARENTS" -lt 3 ]]; then
                  VALID_COUNT=$((VALID_COUNT + 1))
              fi
          done

          # Versioning format:
          # < 100       => 0.0.X
          # 100â€“999     => 0.X.Y
          # 1000+       => X.Y.Z
          if (( VALID_COUNT < 100 )); then
              MAJOR=0
              MINOR=0
              PATCH=$VALID_COUNT
          elif (( VALID_COUNT < 1000 )); then
              MAJOR=0
              MINOR=$((VALID_COUNT / 100))
              PATCH=$((VALID_COUNT % 100))
          else
              MAJOR=$((VALID_COUNT / 1000))
              MINOR=$(((VALID_COUNT % 1000) / 100))
              PATCH=$((VALID_COUNT % 100))
          fi

          PATCH_PADDED=$(printf "%02d" $PATCH)
          VERSION="$MAJOR.$MINOR.$PATCH_PADDED"

          echo "{" > version.json
          echo "  \"version\": \"$VERSION\"," >> version.json
          echo "  \"commitCount\": $VALID_COUNT," >> version.json
          echo "  \"commitHash\": \"$(git rev-parse --short HEAD)\"," >> version.json
          echo "  \"branch\": \"main\"" >> version.json
          echo "}" >> version.json

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Commit and push version file
        id: commit_version
        run: |
          git add -f version.json

          if git diff --cached --quiet; then
            echo "No changes to version file. Skipping commit."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "[skip ci] [ci version bump] Update version.json"
          git push
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: steps.commit_version.outputs.changed == 'true'
        id: tag_version
        run: |
          TAG="v${{ steps.generate_version.outputs.version }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          git fetch --tags --force

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping tag creation."
            exit 0
          fi

          git tag -a "$TAG" -m "Parallax $TAG"
          git push origin "$TAG"

      - name: Create GitHub release
        if: steps.commit_version.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_version.outputs.tag }}
          name: Parallax ${{ steps.tag_version.outputs.tag }}
          generate_release_notes: true
